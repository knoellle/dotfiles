#!/usr/bin/env python
import sys
import requests
import re
import ast
import json

def main():
    if len(sys.argv) != 3:
        print("Invalid number of arguments")
        sys.exit(1)
    # url = "https://nolp.dhl.de/nextt-online-public/report_popup.jsp?piececode=" + sys.argv[1]
    url = "https://www.dhl.de/int-verfolgen/data/shipment?language=de"
    html = requests.post(url, {'piececode': sys.argv[1], "zip": sys.argv[2], "international": False}).text
    print(html)
    data = re.search(r"(?<=JSON\.parse\()(.*)(?=\),)", html, flags=re.MULTILINE)
    js = json.loads(ast.literal_eval(data.group(0)))
    print(json.dumps(js, indent=4))
    details = js.get("sendungen", "")[0].get("sendungsdetails", "")
    delivery = details.get("zustellung", "")
    progress = details.get("sendungsverlauf", "")

    formatdata = {
                "status": progress.get("aktuellerStatus", ""),
                "status_timestamp": progress.get("datumAktuellerStatus", ""),
                "next_step": progress.get("naechsterSchritt", ""),
                "early_delivery": delivery.get("zustellzeitfensterVon", ""),
                "early_delivery_date": delivery.get("zustellzeitfensterVon", "")[:10],
                "late_delivery": delivery.get("zustellzeitfensterBis", ""),
                "late_delivery_date": delivery.get("zustellzeitfensterBis", "")[:10]
            }

    formatstring = "%early_delivery_date%, %status%"
    if len(sys.argv) > 2:
        formatstring = sys.argv[2]
    for k,v in formatdata.items():
        formatstring = formatstring.replace(f"%{k}%", str(v))
    print(formatstring)

if __name__ == "__main__":
    main()
